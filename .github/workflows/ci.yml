name: ci.jig.nvim

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  required:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        nvim: [stable, v0.11.2]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v11
        with:
          luaVersion: "5.4"

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v5

      - name: Install luacheck
        run: luarocks install luacheck

      - name: Install stylua
        uses: taiki-e/install-action@v2
        with:
          tool: stylua

      - name: Install Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: ${{ matrix.nvim }}

      - name: Legacy-brand guard
        run: |
          pattern='(nvim[-_]workbench|nvim(workbench)|nvim[-]2026|nvim(2026)|[N]vimWorkbench|[D]istroHealth|:[D]istro|distro[-]safe|distro[.])'
          if rg -n "$pattern" . ; then
            echo "legacy brand strings detected"
            exit 1
          fi

      - name: Naming checks
        run: |
          set -euo pipefail
          while IFS= read -r file; do
            base="$(basename "$file")"
            if [[ ! "$base" =~ ^[a-z0-9_]+\.lua$ ]]; then
              echo "invalid lua filename: $file"
              exit 1
            fi
          done < <(rg --files lua -g '*.lua')

          while IFS= read -r hit; do
            line="${hit#*:*:}"
            name="$(echo "$line" | sed -nE "s/.*nvim_create_user_command[[:space:]]*\([[:space:]]*['\"]([^'\"]+)['\"].*/\1/p")"
            if [[ -n "$name" && ! "$name" =~ ^Jig[A-Za-z0-9]*$ ]]; then
              echo "invalid command prefix: $hit"
              exit 1
            fi
          done < <(rg -n "nvim_create_user_command[[:space:]]*\(" lua || true)

          while IFS= read -r hit; do
            line="${hit#*:*:}"
            name="$(echo "$line" | sed -nE "s/.*nvim_create_augroup[[:space:]]*\([[:space:]]*['\"]([^'\"]+)['\"].*/\1/p")"
            if [[ -n "$name" && ! "$name" =~ ^Jig[A-Za-z0-9]*$ ]]; then
              echo "invalid augroup prefix: $hit"
              exit 1
            fi
          done < <(rg -n "nvim_create_augroup[[:space:]]*\(" lua || true)

      - name: Boundary checks
        run: |
          set -euo pipefail
          mapfile -t core_files < <(rg --files lua -g '*.lua' | rg '/core/.*\.lua$' || true)
          for file in "${core_files[@]}"; do
            if rg -n "require[[:space:]]*\(?[[:space:]]*['\"][^'\"]*([./]ui[./]|[./]agent[./]|\.ui\.|\.agent\.)" "$file"; then
              echo "forbidden core import: $file"
              exit 1
            fi
            if rg -n "vim\.api\." "$file" >/dev/null 2>&1; then
              if ! rg -n "boundary:[[:space:]]*allow-vim-api" "$file" >/dev/null 2>&1; then
                echo "missing boundary whitelist marker: $file"
                exit 1
              fi
            fi
          done

      - name: Commit message checks
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          range="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          pattern='^(feat|fix|refactor|perf|docs|test|ci|build|chore|revert)(\([a-z0-9._/-]+\))?(!)?: .+'
          while IFS=$'\t' read -r hash subject; do
            [[ -z "$hash" ]] && continue
            [[ "$subject" =~ ^Merge\  ]] && continue
            if [[ ! "$subject" =~ $pattern ]]; then
              echo "invalid commit subject: $hash $subject"
              exit 1
            fi
          done < <(git log --no-merges --format='%H%x09%s' "$range")

      - name: Contract registry checks
        run: |
          lua -e 'package.path="./lua/?.lua;./lua/?/init.lua;"..package.path; assert(require("jig.spec.requirements").self_check())'
          rg -n "MUST|SHOULD|MAY" docs/contract.jig.nvim.md

      - name: Formatting check
        run: stylua --check --config-path .stylua.toml $(rg --files lua -g '*.lua')

      - name: Lint check
        run: luacheck --config .luacheckrc $(rg --files lua -g '*.lua')

      - name: Smoke test startup
        run: |
          nvim --headless -u ./init.lua '+lua print("jig-smoke")' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.g.jig_profile=="default")' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigHealth")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigVerboseMap")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigVerboseSet")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigBisectGuide")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigKeys")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigFiles")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigBuffers")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigRecent")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigSymbols")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigDiagnostics")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigHistory")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigGitChanges")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigLspHealth")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigLspInfo")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigLspSnapshot")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigExec")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigToolHealth")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigTerm")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigMcpList")==0)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigAgentContext")==0)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(package.loaded["jig.agent"]==nil)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigRootSet")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigRootReset")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigPluginInstall")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigPluginUpdate")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigPluginRestore")==2)' '+qa'
          nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigPluginRollback")==2)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.g.jig_profile=="safe")' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(package.loaded["jig.ui"]==nil)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(package.loaded["jig.nav"]==nil)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(package.loaded["jig.lsp"]==nil)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(package.loaded["jig.tools"]==nil)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigFiles")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigLspHealth")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigLspInfo")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigLspSnapshot")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigExec")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigToolHealth")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigTerm")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigMcpList")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(vim.fn.exists(":JigAgentContext")==0)' '+qa'
          NVIM_APPNAME=jig-safe nvim --headless -u ./init.lua '+lua assert(package.loaded["jig.agent"]==nil)' '+qa'

      - name: Cmdline open-close check
        run: nvim --headless -u ./init.lua '+JigCmdlineCheck' '+qa'

      - name: UI harness snapshot checks
        run: |
          tests/ui/run_harness.sh
          test -f tests/ui/snapshots/latest-headless.json
          rg -n '"timing-sensitive"' tests/ui/snapshots/latest-headless.json
          rg -n '"ascii-fallback-legibility"' tests/ui/snapshots/latest-headless.json

      - name: Navigation harness snapshot checks
        run: |
          tests/nav/run_harness.sh
          test -f tests/nav/snapshots/latest-headless.json
          rg -n '"root-determinism"' tests/nav/snapshots/latest-headless.json
          rg -n '"latency-budget-smoke"' tests/nav/snapshots/latest-headless.json
          rg -n '"candidate-cap-guardrail"' tests/nav/snapshots/latest-headless.json

      - name: Keymap harness snapshot checks
        run: |
          tests/keymaps/run_harness.sh
          test -f tests/keymaps/snapshots/latest-headless.json
          rg -n '"forbidden-defaults"' tests/keymaps/snapshots/latest-headless.json
          rg -n '"runtime-forbidden-not-mapped"' tests/keymaps/snapshots/latest-headless.json
          rg -n '"runtime-registry-subset"' tests/keymaps/snapshots/latest-headless.json
          rg -n '"docs-sync-gate"' tests/keymaps/snapshots/latest-headless.json

      - name: Keymap docs sync gate
        run: |
          nvim --headless -u ./init.lua '+lua package.path="./lua/?.lua;./lua/?/init.lua;"..package.path; _G.__jig_repo_root=vim.fn.getcwd(); require("jig.core.keymap_docs").generate({ check = true })' '+qa'

      - name: LSP harness snapshot checks
        run: |
          tests/lsp/run_harness.sh
          test -f tests/lsp/snapshots/latest-headless.json
          rg -n '"default-command-surface"' tests/lsp/snapshots/latest-headless.json
          rg -n '"failure-isolation"' tests/lsp/snapshots/latest-headless.json
          rg -n '"safe-profile-isolation"' tests/lsp/snapshots/latest-headless.json

      - name: Tools harness snapshot checks
        run: |
          tests/tools/run_harness.sh
          test -f tests/tools/snapshots/latest-headless.json
          rg -n '"provider-health-tests"' tests/tools/snapshots/latest-headless.json
          rg -n '"command-execution-smoke"' tests/tools/snapshots/latest-headless.json
          rg -n '"capture-concurrency-guard"' tests/tools/snapshots/latest-headless.json
          rg -n '"timeout-or-nil-path"' tests/tools/snapshots/latest-headless.json
          rg -n '"safe-profile-isolation"' tests/tools/snapshots/latest-headless.json

      - name: Agent harness snapshot checks
        run: |
          tests/agent/run_harness.sh
          test -f tests/agent/snapshots/latest-headless.json
          rg -n '"default-profile-agent-disabled"' tests/agent/snapshots/latest-headless.json
          rg -n '"permission-policy-unit"' tests/agent/snapshots/latest-headless.json
          rg -n '"task-cancel-resume"' tests/agent/snapshots/latest-headless.json
          rg -n '"mcp-failure-injection"' tests/agent/snapshots/latest-headless.json
          rg -n '"acp-bridge-hook"' tests/agent/snapshots/latest-headless.json
          rg -n '"safe-profile-isolation"' tests/agent/snapshots/latest-headless.json

      - name: Deprecated API gate
        run: tests/lsp/check_deprecated.sh

      - name: Startup side-effect policy
        run: |
          set -euo pipefail
          tmp="$(mktemp -d)"
          XDG_DATA_HOME="$tmp/data" \
          XDG_STATE_HOME="$tmp/state" \
          XDG_CACHE_HOME="$tmp/cache" \
          NVIM_APPNAME=jig-ci \
          nvim --headless -u ./init.lua '+qa'
          test ! -d "$tmp/data/jig-ci/lazy/lazy.nvim"

      - name: Health check
        run: nvim --headless -u ./init.lua '+JigHealth' '+qa'

  nightly-report:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Install Neovim (nightly)
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly

      - name: Smoke and health (nightly)
        run: |
          nvim --headless -u ./init.lua '+lua print("jig-smoke-nightly")' '+qa'
          nvim --headless -u ./init.lua '+checkhealth jig' '+qa'
